rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- YARDIMCI FONKSİYONLAR ---
    function isAuthenticated() { return request.auth != null; }
    function isOwner(userId) { return request.auth.uid == userId; }
    function incByOne(oldVal, newVal) {
      return ((oldVal is int || oldVal is float) && newVal == oldVal + 1) ||
             (!(oldVal is int) && !(oldVal is float) && newVal == 1);
    }
    function myLastActiveField() { return request.auth.uid + '_lastActive'; }

    function getUser(uid) {
      return exists(/databases/$(database)/documents/users/$(uid)) ?
             get(/databases/$(database)/documents/users/$(uid)).data :
             null;
    }

    function userRole(uid) {
      let userData = getUser(uid);
      return (userData != null && userData.role != null) ? userData.role : 'user';
    }

    function isBanned(uid) {
      let userData = getUser(uid);
      return userData != null && userData.status == 'banned';
    }

    function isAdmin(uid) { return userRole(uid) == 'admin'; }
    function isModerator(uid) { return userRole(uid) == 'moderator'; }
    function isPrivileged(uid) { return isAdmin(uid) || isModerator(uid); }

    function canBan(targetUid) {
      return (
        isAdmin(request.auth.uid) ||
        (isModerator(request.auth.uid) && !isAdmin(targetUid) && !isModerator(targetUid))
      );
    }

    function isValidDisplayName(name) {
      return name is string && name.size() >= 3 && name.size() <= 29 && name.matches('^[A-Za-z0-9_]{3,29}$');
    }
    function isReservedName(n) {
      return n in ['admin','root','support','moderator','mod','system','null','undefined','owner','staff','team','vocachat','voca','api'];
    }
    function ownsReservedUsername(uname) {
      return exists(/databases/$(database)/documents/usernames/$(uname)) &&
             get(/databases/$(database)/documents/usernames/$(uname)).data.uid == request.auth.uid;
    }

    function callerNotBanned() { return !isBanned(request.auth.uid); }

    function isValidSupportCreate(data) {
      return data.userId == request.auth.uid &&
             data.subject is string && data.subject.size() > 2 && data.subject.size() <= 120 &&
             data.message is string && data.message.size() >= 10 && data.message.size() <= 1000 &&
             data.status == 'open';
    }

    function isBlocked(byUid, targetUid) { return exists(/databases/$(database)/documents/users/$(byUid)/blockedUsers/$(targetUid)); }

    // Yeni validasyon fonksiyonları
    function isValidUrl(url) {
      return url is string &&
             (url.matches('^https://.*') || url.matches('^http://.*')) &&
             url.size() <= 2048;
    }

    function isValidLanguageCode(code) {
      return code is string && code in ['en','tr','de','fr','es','it','pt','ru','ja','ko','zh','ar','hi','nl','pl','sv','no','da','fi','cs','el','he','id','th','vi','uk','ro','hu','bg','hr','sk'];
    }

    function isValidLanguageLevel(level) {
      return level is string && level in ['A1','A2','B1','B2','C1','C2','beginner','intermediate','advanced','native'];
    }

    function isValidTimestamp(ts) {
      return ts is timestamp && ts >= request.time - duration.value(1, 's') && ts <= request.time;
    }

    function isValidAttachments(attachments) {
      return attachments == null ||
             (attachments is list && attachments.size() <= 5);
    }

    // --- GLOBAL ADMIN OVERRIDE ---
    // Admin rolündeki kimliği doğrulanmış kullanıcı her şeyi okuyup yazabilir.
    match /{document=**} {
      allow read, write: if isAuthenticated() && isAdmin(request.auth.uid);
    }

    // --- KOLEKSİYON KURALLARI ---

    match /usernames/{uname} {
      allow create: if isAuthenticated() && callerNotBanned() && !isReservedName(uname) &&
        request.resource.data.keys().hasOnly(['uid','createdAt']) &&
        request.resource.data.uid == request.auth.uid &&
        request.resource.data.createdAt == request.time;
      allow read: if false;
      allow update, delete: if false;
    }

    // Kullanıcı ana belgeleri: sadece sahibi okuyabilir (hassas alanlar burada kalır)
    match /users/{userId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow create: if isAuthenticated() && isOwner(userId) &&
        request.resource.data.uid == request.auth.uid &&
        request.resource.data.email == request.auth.token.email &&
        request.resource.data.role == 'user' &&
        request.resource.data.status == 'active' &&
        request.resource.data.isPremium == false;

      allow update: if
        (
          // Profil alanları + username_lowercase birlikte güncellenebilir
          isOwner(userId) && callerNotBanned() &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly([
            'displayName', 'username_lowercase', 'avatarUrl', 'birthDate', 'nativeLanguage', 'learningLanguage', 'learningLanguageLevel', 'lastActivityDate', 'profileCompleted','streak', 'highestStreak', 'totalRoomTime'
          ]) &&
          // Validasyon kontrolleri
          (!request.resource.data.diff(resource.data).changedKeys().hasAny(['avatarUrl']) ||
           (request.resource.data.avatarUrl == null || isValidUrl(request.resource.data.avatarUrl))) &&
          (!request.resource.data.diff(resource.data).changedKeys().hasAny(['birthDate']) ||
           request.resource.data.birthDate is timestamp) &&
          (!request.resource.data.diff(resource.data).changedKeys().hasAny(['nativeLanguage']) ||
           (request.resource.data.nativeLanguage == null || isValidLanguageCode(request.resource.data.nativeLanguage))) &&
          (!request.resource.data.diff(resource.data).changedKeys().hasAny(['learningLanguage']) ||
           (request.resource.data.learningLanguage == null || isValidLanguageCode(request.resource.data.learningLanguage))) &&
          (!request.resource.data.diff(resource.data).changedKeys().hasAny(['learningLanguageLevel']) ||
           (request.resource.data.learningLanguageLevel == null || isValidLanguageLevel(request.resource.data.learningLanguageLevel))) &&
          (!request.resource.data.diff(resource.data).changedKeys().hasAny(['displayName']) ||
           (request.resource.data.displayName == null || isValidDisplayName(request.resource.data.displayName))) &&
          (
            // username_lowercase değişiyorsa geçerli ve rezerve edilmiş olmalı
            (
              request.resource.data.username_lowercase is string &&
              request.resource.data.username_lowercase.matches('^[a-z0-9_]{3,29}$') &&
              !isReservedName(request.resource.data.username_lowercase) &&
              ownsReservedUsername(request.resource.data.username_lowercase)
            ) || (
              // username_lowercase alanı bu güncellemede yoksa veya değişmiyorsa, diğer profil alanlarına izin ver
              !(request.resource.data.diff(resource.data).changedKeys().hasOnly(['username_lowercase'])) &&
              !(request.resource.data.diff(resource.data).changedKeys().hasAny(['username_lowercase']))
            )
          )
        ) || (
          // FCM token listesi (sadece liste merge/update). Ayrı tutuldu ki diğer alanlarla aynı anda yazılamasın.
          isOwner(userId) && callerNotBanned() &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['fcmTokens']) &&
          request.resource.data.fcmTokens is list &&
          request.resource.data.fcmTokens.size() <= 30
        ) || (
          // Email doğrulaması
          isOwner(userId) && callerNotBanned() &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['emailVerified']) &&
          resource.data.emailVerified == false &&
          request.resource.data.emailVerified == true &&
          request.auth.token.email_verified == true
        ) || (
          // Ban
          isAuthenticated() && canBan(userId) &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['status','bannedReason','bannedDetails','bannedAt','bannedBy']) &&
          request.resource.data.status == 'banned'
        ) || (
          // Unban
          isAuthenticated() && isPrivileged(request.auth.uid) &&
          resource.data.status == 'banned' && request.resource.data.status == 'active' &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['status','bannedReason','bannedDetails','bannedAt','bannedBy','unbannedAt','unbannedBy'])
        ) || (
          // Seviye güncelleme (A1..C2)
          isOwner(userId) && callerNotBanned() &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['level']) &&
          request.resource.data.level in ['A1','A2','B1','B2','C1','C2']
        );

      allow delete: if false;

      match /blockedUsers/{targetId} {
        allow read: if isAuthenticated() && (isOwner(userId) || request.auth.uid == targetId);
        allow create: if isAuthenticated() && isOwner(userId) && callerNotBanned() &&
          request.resource.data.keys().hasOnly(['blockedAt','targetUserId']) &&
          request.resource.data.targetUserId == targetId &&
          request.resource.data.blockedAt == request.time;
        allow update: if isAuthenticated() && isOwner(userId) && callerNotBanned() &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['blockedAt']) &&
          request.resource.data.blockedAt == request.time;
        allow delete: if isAuthenticated() && isOwner(userId) && callerNotBanned();
      }
    }

    // Herkese açık profil görüntüsü: sadece okunabilir, yazma yok (sunucu yazar)
    match /publicUsers/{userId} {
      allow read: if true;
      allow create, update, delete: if false;
    }

    match /reports/{reportId} {
      allow create: if false;
      allow read: if isAuthenticated() && isPrivileged(request.auth.uid);
      allow update: if isAuthenticated() && isPrivileged(request.auth.uid) &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['status','reviewedAt','reviewedBy']) &&
        request.resource.data.status in ['pending','reviewed','dismissed'] &&
        request.resource.data.reviewedAt == request.time;
      allow delete: if false;
    }

    match /support/{ticketId} {
      allow read: if isAuthenticated() && (isOwner(resource.data.userId) || isPrivileged(request.auth.uid));
      allow create: if isAuthenticated() && callerNotBanned() &&
        (getUser(request.auth.uid) != null && getUser(request.auth.uid).isPremium == true) &&
        isValidSupportCreate(request.resource.data) &&
        request.resource.data.keys().hasOnly(['userId','subject','message','status','createdAt','updatedAt','attachments','platform','email','displayName']) &&
        request.resource.data.createdAt == request.time &&
        request.resource.data.updatedAt == request.time &&
        isValidAttachments(request.resource.data.attachments);
      allow update: if isAuthenticated() && isPrivileged(request.auth.uid) &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['status','updatedAt','updatedBy','adminResponse','assignedTo']) &&
        request.resource.data.status in ['open','in_progress','resolved','closed'] &&
        request.resource.data.updatedAt == request.time;
      allow delete: if false;

      match /messages/{messageId} {
        allow read: if isAuthenticated() && (isOwner(get(/databases/$(database)/documents/support/$(ticketId)).data.userId) || isPrivileged(request.auth.uid));
        allow create: if isAuthenticated() && callerNotBanned() && ((
          isOwner(get(/databases/$(database)/documents/support/$(ticketId)).data.userId) &&
          request.resource.data.senderId == request.auth.uid &&
          request.resource.data.senderRole == 'user'
        ) || (
          isPrivileged(request.auth.uid) &&
          request.resource.data.senderId == request.auth.uid &&
          request.resource.data.senderRole == 'admin'
        )) &&
        request.resource.data.keys().hasOnly(['senderId','senderRole','message','timestamp','attachments']) &&
        request.resource.data.message is string && request.resource.data.message.size() > 0 && request.resource.data.message.size() <= 1000 &&
        request.resource.data.timestamp == request.time &&
        isValidAttachments(request.resource.data.attachments);
        allow update, delete: if false;
      }
    }
  }
}
